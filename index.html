<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Archviz Viewer</title>

<style>
body{
  margin:0;
  background:#111;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  color:white;
  font-family:Arial, sans-serif;
}

.viewer{
  aspect-ratio: 9 / 16;
  height: 90vh;
  max-height: 1280px;
  position: relative;
  cursor: grab;
  overflow: hidden;
  background:#000;
}

.viewer img{
  width:100%;
  height:100%;
  object-fit: contain;
  user-select:none;
  pointer-events:none;
  transform-origin:center center;
}

.message{
  text-align:center;
  font-size:18px;
}

.fullscreen-btn{
  position:absolute;
  top:10px;
  right:10px;
  background:rgba(0,0,0,0.6);
  color:#fff;
  border:none;
  padding:8px 12px;
  cursor:pointer;
  font-size:14px;
  z-index:10;
}
</style>
</head>

<body>

<div id="app"></div>

<script>
/* ================= CONFIG ================= */

const BUCKET_BASE =
"https://storage.googleapis.com/archviz-viewer-images";

const TOTAL_X = 24;
const TOTAL_Y = 5;
const ROTATE_SPEED = 0.15;
const PAN_SPEED = 1;

/* =============== URL PARAMS =============== */

const params = new URLSearchParams(window.location.search);

const project = params.get("project");
const view = params.get("view");        // exterior | room
const room = params.get("room");

/* ============== VALIDATION =============== */

if(!project || !view){
  showMessage("Missing project or view in URL");
  throw new Error("Invalid URL");
}

/* ============== PATH SETUP =============== */

let basePath = "";

if(view === "exterior"){
  basePath = `${BUCKET_BASE}/${project}/exterior`;
}
else if(view === "room" && room){
  basePath = `${BUCKET_BASE}/${project}/rooms/${room}`;
}
else{
  showMessage("Room not found");
  throw new Error("Invalid room");
}

/* ============ BUILD VIEWER UI ============ */

const app = document.getElementById("app");

app.innerHTML = `
<div class="viewer" id="viewer">
  <button class="fullscreen-btn" id="fsBtn">⛶</button>
  <img id="frame" />
</div>
`;

const frame = document.getElementById("frame");
const viewer = document.getElementById("viewer");
const fsBtn = document.getElementById("fsBtn");

/* =============== STATE ================= */

let floatX = 1;
let floatY = 1;
let scale = 1;
let isHiRes = false;
let panX = 0, panY = 0;

let isDragging = false;
let startX = 0, startY = 0;

/* ============ IMAGE HELPERS ============= */

function imagePath(index){
  const padded = String(index).padStart(4,"0");

  if(view === "exterior"){
    return isHiRes
      ? `${basePath}/highres/${padded}.png`
      : `${basePath}/lowres/${padded}.png`;
  }

  // rooms = single resolution
  return `${basePath}/${padded}.png`;
}

function updateFrame(){
  const frameX = Math.round(floatX);
  const frameY = Math.round(floatY);
  const index = (frameY - 1) * TOTAL_X + frameX;

  frame.src = imagePath(index);

  frame.onerror = () => {
    showMessage("Room not found");
  };
}

function applyTransform(){
  frame.style.transform =
    `translate(${panX}px, ${panY}px) scale(${scale})`;
}

/* =============== DRAG ================= */

function startDrag(px, py){
  isDragging = true;
  startX = px;
  startY = py;
  viewer.style.cursor = "grabbing";
}

function endDrag(){
  isDragging = false;
  viewer.style.cursor = "grab";
}

function moveDrag(px, py){
  if(!isDragging) return;

  const dx = px - startX;
  const dy = py - startY;

  startX = px;
  startY = py;

  if(scale > 1){
    panX += dx * PAN_SPEED;
    panY += dy * PAN_SPEED;
    applyTransform();
    return;
  }

  floatX -= dx * ROTATE_SPEED;
  floatY += dy * ROTATE_SPEED;

  while(floatX < 1) floatX += TOTAL_X;
  while(floatX > TOTAL_X) floatX -= TOTAL_X;

  floatY = Math.max(1, Math.min(TOTAL_Y, floatY));

  updateFrame();
}

/* ============== EVENTS ============== */

// mouse
viewer.addEventListener("mousedown", e => startDrag(e.clientX, e.clientY));
window.addEventListener("mousemove", e => moveDrag(e.clientX, e.clientY));
window.addEventListener("mouseup", endDrag);

// touch
viewer.addEventListener("touchstart", e=>{
  const t = e.touches[0];
  startDrag(t.clientX, t.clientY);
});

viewer.addEventListener("touchmove", e=>{
  const t = e.touches[0];
  moveDrag(t.clientX, t.clientY);
});

viewer.addEventListener("touchend", endDrag);

// wheel zoom
viewer.addEventListener("wheel", e=>{
  e.preventDefault();

  scale += e.deltaY * -0.002;
  scale = Math.min(Math.max(1, scale), 5);

  if(scale === 1){
    panX = 0;
    panY = 0;
  }

  applyTransform();
},{ passive:false });

// double click → hi-res exterior only
viewer.addEventListener("dblclick", ()=>{
  if(view !== "exterior") return;

  isHiRes = !isHiRes;

  if(isHiRes){
    scale = 3;
  }else{
    scale = 1;
    panX = panY = 0;
  }

  applyTransform();
  updateFrame();
});

// fullscreen
fsBtn.addEventListener("click", ()=>{
  if(!document.fullscreenElement){
    viewer.requestFullscreen();
  }else{
    document.exitFullscreen();
  }
});

/* ============== HELPERS ============== */

function showMessage(text){
  app.innerHTML = `<div class="message">${text}</div>`;
}

/* ============== START ============== */

updateFrame();
</script>

</body>
</html>
