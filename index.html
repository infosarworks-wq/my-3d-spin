<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SAR Works | 3D Viewer</title>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #0e0e0e;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #fff;
    }

    /* â”€â”€ Viewer â”€â”€ */
    #viewer {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      cursor: grab;
      user-select: none;
      -webkit-user-select: none;
    }
    #viewer.dragging { cursor: grabbing; }
    #viewer.zoomed   { cursor: move; }

    #frame {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: contain;
      pointer-events: none;
      transform-origin: center center;
      will-change: transform;
    }

    /* â”€â”€ Overlays â”€â”€ */
    .overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #0e0e0e;
      z-index: 20;
      gap: 12px;
    }
    .overlay.hidden { display: none; }

    /* â”€â”€ Loading bar â”€â”€ */
    .load-logo {
      font-size: 1.3rem;
      font-weight: 700;
      letter-spacing: 4px;
      color: #fff;
      margin-bottom: 10px;
    }
    .load-label {
      font-size: 0.78rem;
      opacity: 0.45;
      margin-bottom: 2px;
    }
    .progress-wrap {
      width: 240px;
      height: 3px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: #c0392b;
      border-radius: 4px;
      transition: width 0.1s linear;
    }
    .progress-pct {
      font-size: 0.72rem;
      opacity: 0.35;
      margin-top: 4px;
    }

    /* â”€â”€ Error â”€â”€ */
    .error-icon  { font-size: 3rem; }
    .error-title { font-size: 1.4rem; font-weight: 600; }
    .error-sub   { font-size: 0.9rem; opacity: 0.6; }

    /* â”€â”€ HUD badges â”€â”€ */
    .hud {
      position: absolute;
      pointer-events: none;
      z-index: 10;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.78rem;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(4px);
    }
    #hud-controls    { bottom: 14px; left: 50%; transform: translateX(-50%); white-space: nowrap; }
    #hud-zoom-tip    { bottom: 14px; right: 56px; display: none; }
    #hud-zoom-active {
      top: 14px; right: 14px;
      background: rgba(180,20,20,0.85);
      display: none;
    }

    /* â”€â”€ Fullscreen button â”€â”€ */
    #btn-fullscreen {
      position: absolute;
      bottom: 10px;
      right: 14px;
      z-index: 10;
      width: 34px;
      height: 34px;
      border-radius: 8px;
      border: none;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(4px);
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    #btn-fullscreen:hover { background: rgba(192,57,43,0.8); }
  </style>
</head>
<body>

<div id="viewer">
  <img id="frame" src="" alt="3D render frame" draggable="false" />

  <!-- Loading overlay -->
  <div class="overlay" id="overlay-loading">
    <div class="load-logo">SAR WORKS</div>
    <div class="load-label" id="load-label">Preparing viewerâ€¦</div>
    <div class="progress-wrap">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
    <div class="progress-pct" id="progress-pct">0%</div>
  </div>

  <!-- Error overlay -->
  <div class="overlay hidden" id="overlay-error">
    <div class="error-icon">âš ï¸</div>
    <div class="error-title" id="error-title">Something went wrong</div>
    <div class="error-sub"  id="error-sub"></div>
  </div>

  <!-- HUD -->
  <div class="hud" id="hud-controls">Drag to rotate &nbsp;Â·&nbsp; Swipe up/down to tilt</div>
  <div class="hud" id="hud-zoom-tip">Double-click to zoom</div>
  <div class="hud" id="hud-zoom-active">ğŸ” ZOOMED â€” drag to pan &nbsp;Â·&nbsp; double-click to exit</div>

  <!-- Fullscreen button -->
  <button id="btn-fullscreen" title="Toggle fullscreen">â›¶</button>
</div>

<script>
/* ============================================================
   SAR Works Â· 3D Spin Viewer  v2.0
   ============================================================
   URL format:
     ?project=sar0001&view=exterior
     ?project=sar0001&view=room&room=kitchen

   Bucket structure:
     {project}/exterior/lowres/0001.jpg  â€¦  0120.jpg
     {project}/exterior/highres/0001.jpg â€¦  0120.jpg
     {project}/rooms/{roomname}/0001.jpg â€¦  0120.jpg

   Grid: 24 cols (360Â° horizontal) x 5 rows (vertical tilt)
   ============================================================ */

// â”€â”€â”€ CONFIGURE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GCS_BUCKET    = 'archviz-viewer-images';
const IMAGE_EXT     = 'jpg';
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const COLS          = 24;
const ROWS          = 5;
const TOTAL_IMAGES  = COLS * ROWS;  // 120
const ZOOM_SCALE    = 3;
const H_SENSITIVITY = 8;
const V_SENSITIVITY = 40;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let project  = '';
let viewType = '';
let roomName = '';
let isExt    = false;

let col = 0;
let row = Math.floor(ROWS / 2);

let zoomed = false;
let panX = 0, panY = 0;

let dragging   = false;
let dragStartX = 0, dragStartY = 0;
let colAtDrag  = 0, rowAtDrag  = 0;
let panAtDragX = 0, panAtDragY = 0;

// Preloaded image cache [0..119]
const cache = new Array(TOTAL_IMAGES);

// â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const viewer        = document.getElementById('viewer');
const frame         = document.getElementById('frame');
const overlayLoad   = document.getElementById('overlay-loading');
const overlayErr    = document.getElementById('overlay-error');
const errTitle      = document.getElementById('error-title');
const errSub        = document.getElementById('error-sub');
const hudControls   = document.getElementById('hud-controls');
const hudZoomTip    = document.getElementById('hud-zoom-tip');
const hudZoomActive = document.getElementById('hud-zoom-active');
const progressBar   = document.getElementById('progress-bar');
const progressPct   = document.getElementById('progress-pct');
const loadLabel     = document.getElementById('load-label');
const btnFS         = document.getElementById('btn-fullscreen');

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pad4(n) { return String(n).padStart(4, '0'); }

function imageURL(r, c, hires = false) {
  const num = pad4(r * COLS + c + 1);  // 1-based filename
  if (isExt) {
    const res = hires ? 'highres' : 'lowres';
    return `https://storage.googleapis.com/${GCS_BUCKET}/${project}/exterior/${res}/${num}.${IMAGE_EXT}`;
  }
  return `https://storage.googleapis.com/${GCS_BUCKET}/${project}/rooms/${encodeURIComponent(roomName)}/${num}.${IMAGE_EXT}`;
}

function showError(title, sub = '') {
  overlayLoad.classList.add('hidden');
  overlayErr.classList.remove('hidden');
  hudControls.style.display = 'none';
  errTitle.textContent = title;
  errSub.textContent   = sub;
}

// â”€â”€ Preloader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function preloadAll() {
  return new Promise((resolve, reject) => {
    let loaded = 0;
    let failed = 0;
    let firstImageFailed = false;

    loadLabel.textContent = 'Loading imagesâ€¦';

    for (let i = 0; i < TOTAL_IMAGES; i++) {
      const r   = Math.floor(i / COLS);
      const c   = i % COLS;
      const img = new Image();
      cache[i]  = img;

      img.onload = () => {
        loaded++;
        const pct = Math.round((loaded / TOTAL_IMAGES) * 100);
        progressBar.style.width = pct + '%';
        progressPct.textContent = pct + '%';
        if (loaded + failed === TOTAL_IMAGES) resolve();
      };

      img.onerror = () => {
        failed++;
        if (i === 0) firstImageFailed = true;
        if (loaded + failed === TOTAL_IMAGES) {
          if (firstImageFailed) reject(new Error('first_image_failed'));
          else resolve();
        }
      };

      img.src = imageURL(r, c);
    }
  });
}

// â”€â”€ Image display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showFrame(r, c, hires = false) {
  if (hires) {
    frame.src = imageURL(r, c, true);
    return;
  }
  // Use preloaded cache for instant, jitter-free display
  const idx = r * COLS + c;
  if (cache[idx] && cache[idx].complete && cache[idx].naturalWidth > 0) {
    frame.src = cache[idx].src;
  } else {
    frame.src = imageURL(r, c, false);
  }
}

// â”€â”€ Zoom â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyTransform() {
  frame.style.transform = zoomed
    ? `scale(${ZOOM_SCALE}) translate(${panX}px, ${panY}px)`
    : 'none';
}

function enterZoom() {
  if (!isExt) return;
  zoomed = true;
  panX = 0; panY = 0;
  viewer.classList.add('zoomed');
  viewer.classList.remove('dragging');
  hudZoomTip.style.display    = 'none';
  hudZoomActive.style.display = 'block';
  showFrame(row, col, true);
  applyTransform();
}

function exitZoom() {
  zoomed = false;
  panX = 0; panY = 0;
  viewer.classList.remove('zoomed');
  hudZoomTip.style.display    = 'block';
  hudZoomActive.style.display = 'none';
  frame.style.transform = 'none';
  showFrame(row, col, false);
}

// â”€â”€ Drag / swipe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startDrag(x, y) {
  dragging   = true;
  dragStartX = x; dragStartY = y;
  colAtDrag  = col; rowAtDrag = row;
  panAtDragX = panX; panAtDragY = panY;
  viewer.classList.add('dragging');
}

function moveDrag(x, y) {
  if (!dragging) return;
  const dx = x - dragStartX;
  const dy = y - dragStartY;

  if (zoomed) {
    panX = panAtDragX + dx / ZOOM_SCALE;
    panY = panAtDragY + dy / ZOOM_SCALE;
    applyTransform();
    return;
  }

  const colDelta = Math.round(-dx / H_SENSITIVITY);
  const newCol   = ((colAtDrag + colDelta) % COLS + COLS) % COLS;
  const rowDelta = Math.round(dy / V_SENSITIVITY);
  const newRow   = Math.max(0, Math.min(ROWS - 1, rowAtDrag + rowDelta));

  if (newCol !== col || newRow !== row) {
    col = newCol;
    row = newRow;
    showFrame(row, col);
  }
}

function endDrag() {
  dragging = false;
  viewer.classList.remove('dragging');
}

// Mouse
viewer.addEventListener('mousedown', e => { e.preventDefault(); startDrag(e.clientX, e.clientY); });
window.addEventListener('mousemove', e => moveDrag(e.clientX, e.clientY));
window.addEventListener('mouseup',   ()  => endDrag());
viewer.addEventListener('dblclick',  ()  => zoomed ? exitZoom() : enterZoom());

// Touch
viewer.addEventListener('touchstart', e => {
  e.preventDefault();
  startDrag(e.touches[0].clientX, e.touches[0].clientY);
}, { passive: false });
viewer.addEventListener('touchmove', e => {
  e.preventDefault();
  moveDrag(e.touches[0].clientX, e.touches[0].clientY);
}, { passive: false });
viewer.addEventListener('touchend', () => endDrag());

// Double-tap
let lastTap = 0;
viewer.addEventListener('touchend', () => {
  const now = Date.now();
  if (now - lastTap < 300) { zoomed ? exitZoom() : enterZoom(); }
  lastTap = now;
});

// â”€â”€ Fullscreen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
btnFS.addEventListener('click', () => {
  if (!document.fullscreenElement) {
    viewer.requestFullscreen().catch(() => {});
    btnFS.textContent = 'âœ•';
    btnFS.title = 'Exit fullscreen';
  } else {
    document.exitFullscreen();
    btnFS.textContent = 'â›¶';
    btnFS.title = 'Toggle fullscreen';
  }
});
document.addEventListener('fullscreenchange', () => {
  if (!document.fullscreenElement) {
    btnFS.textContent = 'â›¶';
    btnFS.title = 'Toggle fullscreen';
  }
});

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  const params = new URLSearchParams(window.location.search);
  project  = (params.get('project') || '').trim();
  viewType = (params.get('view')    || '').trim().toLowerCase();
  roomName = (params.get('room')    || '').trim().toLowerCase();

  if (!project) {
    showError('No project specified.', 'Add ?project=sar0001 to the URL.');
    return;
  }
  if (viewType !== 'exterior' && viewType !== 'room') {
    showError('Invalid view type.', 'Use ?view=exterior or ?view=room&room=kitchen');
    return;
  }
  if (viewType === 'room' && !roomName) {
    showError('Room not found.', 'No room name was provided in the URL.');
    return;
  }

  isExt = (viewType === 'exterior');

  try {
    await preloadAll();
    overlayLoad.classList.add('hidden');
    showFrame(row, col);
    if (isExt) hudZoomTip.style.display = 'block';
  } catch (e) {
    const msg = viewType === 'room'
      ? `Room not found: "${roomName}"`
      : 'Could not load project images.';
    showError(msg, 'Check bucket name, project ID, and folder structure.');
  }
}

init();
</script>
</body>
</html>
